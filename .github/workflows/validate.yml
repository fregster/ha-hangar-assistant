name: Validation

on:
  push:
    branches: 
      - main
      - dev        # Added dev branch support
  pull_request:
    branches: 
      - main
      - dev        # Ensures PRs targeting dev are also checked
  schedule:
    - cron: "0 0 * * *"

jobs:
  # 1. Official Home Assistant Validation (Hassfest)
  validate-hassfest:
    runs-on: ubuntu-latest
    name: Hassfest (HA Official)
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Hassfest Action
        uses: home-assistant/actions/hassfest@master

  ## Disabled for now - uncomment to re-enable
  # 2. HACS Compliance Validation
  #validate-hacs:
  #  name: HACS (Store Compliance)
  #  runs-on: ubuntu-latest
  #  steps:
  #    - name: Checkout Repository
  #      uses: actions/checkout@v4

  #    - name: HACS Action
  #      uses: hacs/action@main
  #      with:
  #         category: integration

  # 3. Code Quality (Flake8)
  validate-lint:
    runs-on: ubuntu-latest
    name: Lint (Code Quality)
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          pip install -r requirements_test.txt

      - name: Lint with Flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings.
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Verify Version consistency
        run: |
          VERSION=$(grep '"version":' custom_components/hangar_assistant/manifest.json | cut -d '"' -f 4)
          echo "Manifest version is $VERSION"
          if [[ -z "$VERSION" ]]; then
            echo "Error: Version not found in manifest.json"
            exit 1
          fi

  # 4. Type Checking (MyPy)
  validate-types:
    runs-on: ubuntu-latest
    name: Type Check (MyPy)
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          pip install -r requirements_test.txt

      - name: Run MyPy
        run: |
          mypy custom_components/hangar_assistant --ignore-missing-imports

  # 5. Unit & Integration Tests
  validate-tests:
    runs-on: ubuntu-latest
    name: Tests (Pytest)
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: |
          pip install -r requirements_test.txt

      - name: Run Tests
        run: |
          pytest tests/