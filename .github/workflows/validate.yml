name: Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *"

jobs:
  # 1. Official Home Assistant Validation (Hassfest)
  validate-hassfest:
    runs-on: ubuntu-latest
    name: Hassfest (HA Official)
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Hassfest Action
        uses: home-assistant/actions/hassfest@master

  # 2. HACS Compliance Validation
  validate-hacs:
    runs-on: ubuntu-latest
    name: HACS (Store Compliance)
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: HACS Action
        uses: hacs/action@main
        with:
          category: integration

  # 3. Code Quality (Flake8)
  validate-lint:
    runs-on: ubuntu-latest
    name: Lint (Code Quality)
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Lint with Flake8
        run: |
          pip install flake8
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Verify Version consistency
        run: |
          VERSION=$(grep '"version":' custom_components/hangar_assistant/manifest.json | cut -d '"' -f 4)
          echo "Manifest version is $VERSION"
          if [[ -z "$VERSION" ]]; then
            echo "Error: Version not found in manifest.json"
            exit 1
          fi